<script setup>
import { useModalStore } from '../../stores/modal.store'
import SpinnerIcon from '../../assets/icons/SpinnerIcon.vue'
import XIcon from '../../assets/icons/XIcon.vue'
import { ref, reactive } from 'vue'
import TaskService from '../../services/task.service'
import { toast } from 'vue-sonner'

const isLoading = ref(false)

const taskForm = reactive({
  title: '',
  filename: '',
  dueDate: '',
  description: '',
})

const onFileSelected = (e) => {
  var files = e.target.files || e.dataTransfer.files;
  if (!files.length) {
    return;
  }
  taskForm.filename = files[0].name;
  filename.value = files[0].name;
}

const clearForm = () => {
  taskForm.title = ''
  taskForm.filename = ''
  taskForm.dueDate = ''
  taskForm.description = ''
}

const closeModal = () => {
  useModalStore().closeAddTaskModal()
  clearForm()
}

const submitData = () => {
  if (!taskForm.title) {
    toast.error("Please enter title")
  } else if (!taskForm.filename) {
    toast.error("Please select file")
  } else if (!taskForm.dueDate) {
    toast.error("Please enter dueDate")
  } else if (!taskForm.description) {
    toast.error("Please enter description")
  } else {
    isLoading.value = true
    TaskService.createTask(taskForm)
      .then(() => {
        toast.success("Successfully created task")
        isLoading.value = false
        closeModal();
      })
      .catch((err) => {
        toast.error("Error creating task")
        isLoading.value = false
      })
  }
}

</script>
<template>
  <div v-if="useModalStore().isOpenAddTaskModal"
    class="fixed top-0 left-0 right-0 z-50 w-full max-h-screen overflow-x-hidden overflow-y-auto backdrop-blur bg-gray-900/75 md:inset-0 md:h-full">
    <div class="relative w-full h-full max-w-xl p-4 -translate-x-1/2 -translate-y-1/2 md:h-auto left-1/2 top-1/2">
      <div class="relative p-4 bg-white border rounded-lg shadow">
        <div class="flex items-center justify-between mb-6">
          <h1 class="flex items-center text-2xl font-bold">Add task</h1>
          <button @click="closeModal()"
            class="text-gray-600 bg-gray-100 hover:bg-gray-200 transition-all duration-300 rounded-full text-sm p-1.5 inline-flex items-center">
            <XIcon />
          </button>
        </div>
        <div class="space-y-3">
          <div>
            <label for="title" class="mb-1 text-sm font-medium leading-6 text-gray-900">
              Title
            </label>
            <input v-model="taskForm.title" id="title" type="text" placeholder="Task title"
              class="block w-full rounded border-0 py-1.5 px-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-1 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
          </div>
          <div>
            <label for="file" class="mb-1 text-sm font-medium leading-6 text-gray-900">
              Upload file
            </label>
            <input @change="onFileSelected" id="file" type="file" placeholder="Task title"
              class="block w-full rounded border-0 py-1.5 px-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-1 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
          </div>

          <!-- <div class="relative block">
            <label>Attach file task</label>
            <label for="filename" v-if="!taskForm.filename"
              class="block w-full leading-tight border rounded shadow appearance-none resize-none h-min focus:outline-none focus:shadow-outline">Attach
              file task</label>
            <label
              class="block w-full px-3 py-2 leading-tight border rounded shadow appearance-none resize-none h-min focus:outline-none focus:shadow-outline"
              v-if="taskForm.filename" v-text="filename"></label>
            <div class="relative flex-grow textarea-container">
              <input type="file" class="hidden" id="filename" name="filename" placeholder="" @change="onFileSelected" />
              <div class="svg-container z-[-10] absolute bottom-2 right-3 flex items-center">
                <PaperclipIcon class="bg-black hover:bg-gray-500" />
              </div>
            </div>
          </div> -->

          <div>
            <label for="due-date" class="mb-1 text-sm font-medium leading-6 text-gray-900">
              Due date
            </label>
            <input v-model="taskForm.dueDate" id="due-date" type="date"
              class="block w-full rounded border-0 py-1.5 px-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-1 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
          </div>
          <div>
            <label for="assign" class="mb-1 text-sm font-medium leading-6 text-gray-900">Assign</label>
            <select id="assign"
              class="block w-full px-2 py-2 text-gray-900 bg-white border-0 rounded shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
              <option>United States</option>
              <option>Canada</option>
              <option>Mexico</option>
            </select>
          </div>

          <div>
            <label for="description" class="mb-1 text-sm font-medium leading-6 text-gray-900">Description</label>
            <textarea v-model="taskForm.description" id="description" rows="4" placeholder="Comment here"
              class="block w-full rounded border-0 py-1.5 px-2 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"></textarea>
          </div>
        </div>
        <div class="flex items-center justify-end mt-6">
          <button v-if="!isLoading" @click="submitData()" type="button"
            class="px-3 py-2 text-sm font-semibold text-white bg-indigo-600 rounded shadow-sm w-36 hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Create task
          </button>
          <button v-else type="button"
            class="flex items-center justify-center px-3 py-2 space-x-1 text-sm font-semibold text-white bg-indigo-600 rounded shadow-sm cursor-default w-36">
            <SpinnerIcon class="w-5 h-5" />
            <span>Creating task</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped></style>